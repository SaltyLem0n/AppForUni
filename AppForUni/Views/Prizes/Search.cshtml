@{
    ViewData["Title"] = "ค้นหาผู้ได้รับรางวัล";
    string popupTitle = (string)(ViewBag.PopupTitle ?? "");
    string popupMsg = (string)(ViewBag.PopupMessage ?? "");
    string popupType = (string)(ViewBag.PopupType ?? "");
    string employeeId = (string)(ViewBag.EmployeeId ?? "");

    // Get the list of ALL winners
    var allWinners = ViewBag.AllWinners as List<YourApp.Models.PrizeAward> ?? new List<YourApp.Models.PrizeAward>();

    bool isSuccess = popupType == "success";
    bool isErrorOrInfo = (popupType == "error" || popupType == "info");
}


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&amp;family=DM+Sans:wght@400;500;600&amp;display=swap" rel="stylesheet">
<link rel="stylesheet" href="~/css/search.css" />

<div class="page-background-wrapper">
    <div class="radial-grid"></div>
    <div class="mesh-blob blob-1"></div>
    <div class="mesh-blob blob-2"></div>
</div>

<div class="search-wrapper">

    <div class="search-card-section">
        <div class="search-card" style="width:100%;">
            <h2 class="search-title">ค้นหาผู้ได้รับรางวัล</h2>
            <form asp-action="Search" method="post">
                @Html.AntiForgeryToken()
                <div class="input-group-custom">
                    <label class="input-label" for="empSearch">รหัสพนักงาน</label>
                    <input id="empSearch" type="text" name="employeeId" class="search-input"
                        placeholder="กรอก/สแกนรหัสพนักงาน" autofocus autocomplete="off" />
                </div>
                <button type="submit" class="btn-search-submit">ค้นหา</button>
            </form>
            <div class="divider"></div>

            @*
            <a asp-action="Select" class="btn-back-outline">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            style="margin-right:4px;">
            <path d="M19 12H5" />
            <path d="M12 19l-7-7 7-7" />
            </svg>
            กลับหน้าเลือกรางวัล
            </a>
            *@
        </div>
    </div>

   
    <!-- Winners Table Section - Standalone Table with Light Theme -->
    <div class="winners-light-wrapper">
        <!-- Table Container -> Light Theme -->
        <div class="winners-light-card">
            <div class="winners-light-scroll">
                <table class="winners-light-table" id="mainTable">
                    <thead class="winners-light-thead">
                        <tr class="winners-light-tr-head">
                            <th class="winners-light-th w-prize">รางวัล </th>
                            <th class="winners-light-th text-center">ลำดับ </th>
                            <th class="winners-light-th text-right">รหัสบุคลากร </th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="winners-light-tbody">
                        @if (allWinners != null && allWinners.Count > 0)
                        {
                            int i = 0;
                            foreach (var w in allWinners)
                            {
                                i++;
                                string emoji = "🎗️";
                                // Default light bg
                                string bgColor = "#ffffff"; 
                                string amount = ""; 
                                
                                // Text Colors
                                string prizeTextColor = "#1e293b"; // Slate-800
                                string idTextColor = "#334155"; // Slate-700
                                string rankTextColor = "#64748b"; // Slate-500

                                // Infer style based on Prize Name
                                if (w.PrizeName.Contains("รางวัลที่ 1")) { emoji = "🏆"; bgColor = "#fefce8"; amount = "50,000 บาท"; prizeTextColor = "#b45309"; } // Yellow-50
                                else if (w.PrizeName.Contains("รางวัลที่ 2")) { emoji = "🥈"; bgColor = "#f8fafc"; amount = "30,000 บาท"; prizeTextColor = "#334155"; } // Slate-50
                                else if (w.PrizeName.Contains("รางวัลที่ 3")) { emoji = "🥉"; bgColor = "#fff7ed"; amount = "10,000 บาท"; prizeTextColor = "#c2410c"; } // Orange-50
                                else if (w.PrizeName.Contains("รางวัลที่ 4")) { emoji = "🎖️"; bgColor = "#f0f9ff"; amount = "5,000 บาท"; } // Sky-50
                                else if (w.PrizeName.Contains("รางวัลที่ 5")) { emoji = "🎗️"; bgColor = "#fdf2f8"; amount = "2,000 บาท"; } // Pink-50
                                else { emoji = "🎁"; bgColor = "#ffffff"; amount = ""; }

                                // Fallback logic
                                if (i == 1 && !w.PrizeName.Contains("รางวัล")) { emoji = "🏆"; bgColor = "#fefce8"; prizeTextColor = "#b45309"; }
                            
                                <tr class="winners-light-tr" style="background: @bgColor;">
                                    <td class="winners-light-td">
                                        <div class="prize-content-flex">
                                            <span class="prize-emoji">@emoji</span>
                                            <div class="prize-details">
                                                <div class="prize-name" style="color: @prizeTextColor;">@w.PrizeName</div>
                                                <div class="prize-amount">@amount</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="winners-light-td" style="text-align:center; color: @rankTextColor; font-weight:600;">@i</td>
                                    <td class="winners-light-td" style="text-align:right; color: @idTextColor; font-family: monospace; font-weight:700; font-size:1.125rem; letter-spacing:0.05em;">@w.EmployeeID</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="3" style="padding: 2rem; text-align: center; color: #94a3b8;">
                                    ยังไม่มีประกาศรายชื่อผู้โชคดี
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            

        </div>
    </div>

</div>

<div id="winnerPopup" class="popup-overlay" style="@(isSuccess ? "display:flex;" : "display:none;")">
    <div class="popup-container winner-theme" id="winnerContainer">
        <div class="trophy-icon">🏆</div>
        <h1 class="winner-title">@popupTitle</h1>
        <h2 class="winner-name">ID: @employeeId</h2>
        <div class="prize-box">
            <div class="prize-label">คุณได้รับรางวัล</div>
            <div class="prize-name-text">@popupMsg</div>
        </div>
        <button class="btn-claim" onclick="closePopup('winnerPopup')">ปิด</button>
    </div>
</div>

<div id="errorPopup" class="popup-overlay" style="@(isErrorOrInfo ? "display:flex;" : "display:none;")">
    <div class="popup-container nowin-theme">
        <div class="emoji-icon">
            @if (popupType == "error")
            {
                <text>❌</text>
            }
            else
            {
                <text>😢</text>
            }
        </div>
        <h1 class="main-title">@popupTitle</h1>
        <p class="encouragement">
            @if (popupType == "error")
            {
                <text>ข้อผิดพลาด</text>
            }
            else
            {
                <text>เสียใจด้วย!</text>
            }
        </p>
        <div style="padding:15px; background:rgba(59,130,246,0.1); border-radius:12px; margin:20px 0;">
            <p style="font-size:16px;">@popupMsg</p>
        </div>
        <button class="btn-try-again" onclick="closePopup('errorPopup')">ปิด</button>
    </div>
</div>



<script>
    function closePopup(id) {
        document.getElementById(id).style.display = 'none';
        document.getElementById('empSearch').value = ''; // Clear input on close
        document.getElementById('empSearch').focus();
    }
    


    // Animation Logic
    window.addEventListener('load', () => {
        const isWinner = document.getElementById('winnerPopup').style.display === 'flex';
        if (isWinner) {
            createConfetti();
            createMoneyRain();
            createSparkles();
        }
    });

    // Helper Animation Functions
    function createConfetti() {
        const colors = ['#fbbf24', '#10b981', '#6366f1', '#ec4899', '#f59e0b', '#8b5cf6'];
        for (let i = 0; i < 50; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-10px';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 3500);
            }, i * 50);
        }
    }

    function createMoneyRain() {
        const moneyEmojis = ['💵', '💰', '💸', '💴', '💶', '💷'];
        for (let i = 0; i < 30; i++) {
            setTimeout(() => {
                const money = document.createElement('div');
                money.className = 'money';
                money.textContent = moneyEmojis[Math.floor(Math.random() * moneyEmojis.length)];
                money.style.left = Math.random() * 100 + '%';
                money.style.top = '-50px';
                money.style.animationDelay = Math.random() * 0.8 + 's';
                money.style.animationDuration = (Math.random() * 2 + 3) + 's';
                document.body.appendChild(money);
                setTimeout(() => money.remove(), 5000);
            }, i * 100);
        }
    }

    function createSparkles() {
        const container = document.getElementById('winnerContainer');
        const sparkleColors = ['#fbbf24', '#ffffff', '#fef3c7'];
        if (!container) return;
        for (let i = 0; i < 12; i++) {
            const sparkle = document.createElement('div');
            sparkle.className = 'sparkle';
            sparkle.style.background = sparkleColors[Math.floor(Math.random() * sparkleColors.length)];
            sparkle.style.left = Math.random() * 100 + '%';
            sparkle.style.top = Math.random() * 100 + '%';
            sparkle.style.animationDelay = Math.random() * 1.5 + 's';
            container.appendChild(sparkle);
        }
    }
</script>