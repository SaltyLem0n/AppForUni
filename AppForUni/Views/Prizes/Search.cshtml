@{
    ViewData["Title"] = "ค้นหาผู้ได้รับรางวัล";
    string popupTitle = (string)(ViewBag.PopupTitle ?? "");
    string popupMsg = (string)(ViewBag.PopupMessage ?? "");
    string popupType = (string)(ViewBag.PopupType ?? "");
    string employeeId = (string)(ViewBag.EmployeeId ?? "");

    // Get the list of ALL winners
    var allWinners = ViewBag.AllWinners as List<YourApp.Models.PrizeAward> ?? new List<YourApp.Models.PrizeAward>();

    bool isSuccess = popupType == "success";
    bool isErrorOrInfo = (popupType == "error" || popupType == "info");
}

<link rel="stylesheet" href="~/css/search.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&amp;family=DM+Sans:wght@400;500;600&amp;display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<style>
    @@importurl('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&family=Poppins:wght@400;600;700;800&display=swap');

    /* --- Main Layout --- */
    .search-wrapper {
        display: flex;
        flex-direction: column; /* Stack vertically as requested */
        gap: 40px;
        justify-content: flex-start;
        align-items: center;
        width: 100%;
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 20px;
        position: relative;
        z-index: 10;
    }

    /* Left Side: Search Card */
    /* Left Side: Search Card */
    .search-card-section {
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
    }

    /* Right Side: Winners Table */
    .winners-section {
        flex: 1;
        min-width: 300px;
        max-width: 450px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 24px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        height: fit-content;
        max-height: 600px;
        display: flex;
        flex-direction: column;
    }

    .winners-header {
        font-family: 'Poppins', sans-serif;
        font-size: 18px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .winners-list-container {
        overflow-y: auto;
        flex-grow: 1;
        padding-right: 5px;
    }

    /* --- New Design Animations & Fonts --- */
    .font-heading {
      font-family: 'Playfair Display', Georgia, serif;
    }

    .font-body {
      font-family: 'DM Sans', system-ui, sans-serif;
    }

    @@keyframes shimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }

    .gold-shimmer {
      background: linear-gradient(90deg, #D4AF37 0%, #F5E7A3 25%, #D4AF37 50%, #F5E7A3 75%, #D4AF37 100%);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: shimmer 3s linear infinite;
    }

    @@keyframes float-trophy {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .trophy-float-anim {
      animation: float-trophy 3s ease-in-out infinite;
    }

    .row-hover {
      transition: all 0.3s ease;
    }

    .row-hover:hover {
      transform: scale(1.02);
      box-shadow: 0 8px 30px rgba(212, 175, 55, 0.3);
    }

    /* Table Styles */
    .table-custom {
        width: 100%;
        border-collapse: collapse;
    }

    .table-custom th {
        text-align: left;
        color: #64748b;
        font-size: 14px;
        padding: 8px;
        border-bottom: 1px solid #f1f5f9;
    }

    .table-custom td {
        padding: 10px 8px;
        border-bottom: 1px solid #f1f5f9;
        font-size: 15px;
        color: #334155;
    }

    .table-custom tr:last-child td {
        border-bottom: none;
    }

    .prize-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 700;
        background: #f1f5f9;
        color: #475569;
    }

    /* Simple color coding for prizes */
    .prize-1 {
        background: #fef3c7;
        color: #d97706;
    }

    /* Gold */
    .prize-2 {
        background: #e2e8f0;
        color: #475569;
    }

    /* Silver/Grey */
    .prize-3 {
        background: #ffedd5;
        color: #c2410c;
    }

    /* Bronze/Orange */

    .emp-id-text {
        font-family: 'Courier New', monospace;
        font-weight: 600;
    }

    /* --- Popup CSS --- */
    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        z-index: 9999;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.4s ease-out;
    }

    .popup-container.winner-theme {
        background: #ffffff;
        font-family: 'Poppins', sans-serif;
        color: #1e293b;
        max-width: 500px;
        border-radius: 24px;
        padding: 48px 40px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.1s forwards;
    }

    .popup-container.nowin-theme {
        background: #ffffff;
        font-family: 'Quicksand', sans-serif;
        color: #0f172a;
        max-width: 480px;
        border-radius: 28px;
        padding: 56px 44px;
        text-align: center;
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15);
        animation: gentlePopIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s forwards;
    }

    .trophy-icon {
        font-size: 80px;
        margin-bottom: 24px;
        animation: bounce 1s ease-in-out infinite;
        display: inline-block;
    }

    .winner-title {
        font-size: 48px;
        font-weight: 800;
        margin-bottom: 16px;
        color: #1e293b;
    }

    .winner-name {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 12px;
        color: #fbbf24;
    }

    .prize-box {
        display: inline-block;
        padding: 16px 32px;
        border-radius: 16px;
        margin: 24px 0;
        background: rgba(251, 191, 36, 0.15);
        border: 2px solid #fbbf24;
    }

    .prize-label {
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 8px;
        opacity: 0.9;
    }

    .prize-name-text {
        font-size: 24px;
        font-weight: 700;
    }

    .btn-claim {
        padding: 18px 48px;
        border-radius: 50px;
        font-size: 18px;
        font-weight: 700;
        border: none;
        cursor: pointer;
        background: #10b981;
        color: white;
        transition: all 0.3s ease;
        text-transform: uppercase;
    }

    .emoji-icon {
        font-size: 72px;
        display: inline-block;
        animation: gentleFloat 2.5s ease-in-out infinite;
    }

    .main-title {
        font-size: 42px;
        font-weight: 700;
        margin-bottom: 12px;
    }

    .encouragement {
        font-size: 26px;
        font-weight: 600;
        margin-bottom: 28px;
        color: #3b82f6;
    }

    .btn-try-again {
        padding: 16px 42px;
        border-radius: 50px;
        font-size: 17px;
        font-weight: 700;
        border: none;
        cursor: pointer;
        background: #6366f1;
        color: white;
        transition: all 0.3s ease;
        text-transform: uppercase;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @@keyframes popIn {
        to {
            transform: scale(1);
        }
    }

    @@keyframes gentlePopIn {
        to {
            transform: scale(1);
        }
    }

    @@keyframes bounce {

        0%,
        100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-10px);
        }
    }

    @@keyframes gentleFloat {

        0%,
        100% {
            transform: translateY(0) rotate(-3deg);
        }

        50% {
            transform: translateY(-12px) rotate(3deg);
        }
    }

    @@keyframes confettiFall {
        to {
            transform: translateY(100vh) rotate(720deg);
            opacity: 0;
        }
    }

    @@keyframes moneyFall {
        0% {
            transform: translateY(-50px);
            opacity: 0.9;
        }

        100% {
            transform: translateY(100vh) rotate(360deg);
            opacity: 0;
        }
    }

    @@keyframes sparkle {

        0%,
        100% {
            opacity: 0;
            transform: scale(0);
        }

        50% {
            opacity: 1;
            transform: scale(1);
        }
    }

    .confetti {
        position: fixed;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        pointer-events: none;
        animation: confettiFall 3s ease-out forwards;
        z-index: 10000;
    }

    .money {
        position: fixed;
        font-size: 32px;
        pointer-events: none;
        animation: moneyFall 4s ease-out forwards;
        opacity: 0.9;
        z-index: 10000;
    }

    .sparkle {
        position: absolute;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        animation: sparkle 1.5s ease-in-out infinite;
    }
    
    /* New Table Snippet Styles */
    body {
        box-sizing: border-box;
    }
    
    .font-heading {
        font-family: 'Playfair Display', Georgia, serif;
    }
    
    @@keyframes shimmer-gold {
        0% { background-position: -200% center; }
        100% { background-position: 200% center; }
    }
    
    .gold-shimmer-text {
        background: linear-gradient(90deg, #D4AF37 0%, #F5E7A3 25%, #D4AF37 50%, #F5E7A3 75%, #D4AF37 100%);
        background-size: 200% auto;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: shimmer-gold 3s linear infinite;
    }
    
    @@keyframes float-item {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }
    
    .trophy-float-effect {
        animation: float-item 3s ease-in-out infinite;
    }
    
    @@keyframes sparkle-fade {
        0%, 100% { opacity: 0; transform: scale(0); }
        50% { opacity: 1; transform: scale(1); }
    }
    
    .sparkle-effect {
        position: absolute;
        width: 8px;
        height: 8px;
        background: #F5E7A3;
        border-radius: 50%;
        animation: sparkle-fade 2s ease-in-out infinite;
    }
    
    .table-scroll-container {
        scrollbar-width: thin;
        scrollbar-color: rgba(212, 175, 55, 0.5) rgba(255, 255, 255, 0.1);
    }
    
    .table-scroll-container::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    .table-scroll-container::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
    }
    
    .table-scroll-container::-webkit-scrollbar-thumb {
        background: rgba(212, 175, 55, 0.5);
        border-radius: 4px;
    }
    
    .table-scroll-container::-webkit-scrollbar-thumb:hover {
        background: rgba(212, 175, 55, 0.7);
    }
    
    .table-tbody-tr {
        transition: all 0.2s ease;
    }
    
    .table-tbody-tr:hover {
        background: rgba(212, 175, 55, 0.1) !important;
        transform: scale(1.005);
    }
</style>

<div class="page-background-wrapper">
    <div class="radial-grid"></div>
    <div class="mesh-blob blob-1"></div>
    <div class="mesh-blob blob-2"></div>
</div>

<div class="search-wrapper">

    <div class="search-card-section">
        <div class="search-card" style="width:100%;">
            <h2 class="search-title">ค้นหาผู้ได้รับรางวัล</h2>
            <form asp-action="Search" method="post">
                @Html.AntiForgeryToken()
                <div class="input-group-custom">
                    <label class="input-label" for="empSearch">รหัสพนักงาน</label>
                    <input id="empSearch" type="text" name="employeeId" class="search-input"
                        placeholder="กรอก/สแกนรหัสพนักงาน" autofocus autocomplete="off" />
                </div>
                <button type="submit" class="btn-search-submit">ค้นหา</button>
            </form>
            <div class="divider"></div>

            @*
            <a asp-action="Select" class="btn-back-outline">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            style="margin-right:4px;">
            <path d="M19 12H5" />
            <path d="M12 19l-7-7 7-7" />
            </svg>
            กลับหน้าเลือกรางวัล
            </a>
            *@
        </div>
    </div>

   
    <!-- Winners Table Section - Standalone Table with Light Theme -->
    <div class="winners-table-wrapper-new w-full max-w-5xl mx-auto">
        <!-- Table Container -> Light Theme -->
        <div class="rounded-2xl overflow-hidden" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid #e2e8f0; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05); max-height: 70vh;">
            <div class="table-scroll-container overflow-auto" style="max-height: 70vh;">
                <table class="w-full text-left border-collapse" id="mainTable">
                    <thead class="sticky top-0 z-10" style="background: #f1f5f9; border-bottom: 2px solid #e2e8f0;">
                        <tr class="text-lg uppercase tracking-wider font-bold" style="color: #004aad;">
                            <th class="p-4 min-w-[180px]">รางวัล </th>
                            <th class="p-4 min-w-[80px] text-center">ลำดับ </th>
                            <th class="p-4 min-w-[250px] text-right">รหัสบุคลากร </th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="text-sm divide-y" style="divide-color: #f1f5f9;">
                        @if (allWinners != null && allWinners.Count > 0)
                        {
                            int i = 0;
                            foreach (var w in allWinners)
                            {
                                i++;
                                string emoji = "🎗️";
                                // Default light bg
                                string bgColor = "#ffffff"; 
                                string amount = ""; 
                                
                                // Text Colors
                                string prizeTextColor = "#1e293b"; // Slate-800
                                string idTextColor = "#334155"; // Slate-700
                                string rankTextColor = "#64748b"; // Slate-500

                                // Infer style based on Prize Name
                                if (w.PrizeName.Contains("รางวัลที่ 1")) { emoji = "🏆"; bgColor = "#fefce8"; amount = "50,000 บาท"; prizeTextColor = "#b45309"; } // Yellow-50
                                else if (w.PrizeName.Contains("รางวัลที่ 2")) { emoji = "🥈"; bgColor = "#f8fafc"; amount = "30,000 บาท"; prizeTextColor = "#334155"; } // Slate-50
                                else if (w.PrizeName.Contains("รางวัลที่ 3")) { emoji = "🥉"; bgColor = "#fff7ed"; amount = "10,000 บาท"; prizeTextColor = "#c2410c"; } // Orange-50
                                else if (w.PrizeName.Contains("รางวัลที่ 4")) { emoji = "🎖️"; bgColor = "#f0f9ff"; amount = "5,000 บาท"; } // Sky-50
                                else if (w.PrizeName.Contains("รางวัลที่ 5")) { emoji = "🎗️"; bgColor = "#fdf2f8"; amount = "2,000 บาท"; } // Pink-50
                                else { emoji = "🎁"; bgColor = "#ffffff"; amount = ""; }

                                // Fallback logic
                                if (i == 1 && !w.PrizeName.Contains("รางวัล")) { emoji = "🏆"; bgColor = "#fefce8"; prizeTextColor = "#b45309"; }
                            
                                <tr class="table-tbody-tr" style="background: @bgColor; transition: background-color 0.2s;">
                                    <td class="p-4">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">@emoji</span>
                                            <div>
                                                <div class="font-semibold" style="color: @prizeTextColor;">@w.PrizeName</div>
                                                <div class="text-xs" style="color: #64748b;">@amount</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="p-4 text-center font-semibold" style="color: @rankTextColor;">@i</td>
                                    <td class="p-4 text-right font-mono font-bold text-lg" style="color: @idTextColor; letter-spacing: 0.05em;">@w.EmployeeID</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="3" class="p-8 text-center text-gray-400">
                                    ยังไม่มีประกาศรายชื่อผู้โชคดี
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            
            <!-- Copy Button -->
            <button id="copyBtn" class="w-full py-3 font-semibold text-sm transition-all duration-300 hover:bg-slate-50" style="background: white; color: #475569; border-top: 1px solid #e2e8f0;">
                📋 Copy Table Content
            </button>
        </div>
    </div>

</div>

<div id="winnerPopup" class="popup-overlay" style="@(isSuccess ? "display:flex;" : "display:none;")">
    <div class="popup-container winner-theme" id="winnerContainer">
        <div class="trophy-icon">🏆</div>
        <h1 class="winner-title">@popupTitle</h1>
        <h2 class="winner-name">ID: @employeeId</h2>
        <div class="prize-box">
            <div class="prize-label">คุณได้รับรางวัล</div>
            <div class="prize-name-text">@popupMsg</div>
        </div>
        <button class="btn-claim" onclick="closePopup('winnerPopup')">ปิด</button>
    </div>
</div>

<div id="errorPopup" class="popup-overlay" style="@(isErrorOrInfo ? "display:flex;" : "display:none;")">
    <div class="popup-container nowin-theme">
        <div class="emoji-icon">
            @if (popupType == "error")
            {
                <text>❌</text>
            }
            else
            {
                <text>😢</text>
            }
        </div>
        <h1 class="main-title">@popupTitle</h1>
        <p class="encouragement">
            @if (popupType == "error")
            {
                <text>ข้อผิดพลาด</text>
            }
            else
            {
                <text>เสียใจด้วย!</text>
            }
        </p>
        <div style="padding:15px; background:rgba(59,130,246,0.1); border-radius:12px; margin:20px 0;">
            <p style="font-size:16px;">@popupMsg</p>
        </div>
        <button class="btn-try-again" onclick="closePopup('errorPopup')">ปิด</button>
    </div>
</div>

<div id="toast" class="fixed bottom-5 right-5 px-6 py-3 rounded-lg font-semibold shadow-2xl transition-all duration-300 z-50 transform translate-y-20 opacity-0" style="background: linear-gradient(135deg, #D4AF37 0%, #F5E7A3 100%); color: #1a1a2e;">
   📋 Table content copied!
</div>

<script>
    function closePopup(id) {
        document.getElementById(id).style.display = 'none';
        document.getElementById('empSearch').value = ''; // Clear input on close
        document.getElementById('empSearch').focus();
    }
    
    // Copy to Clipboard Functionality
    function copyTableToClipboard() {
        const table = document.getElementById('mainTable');
        let textContent = '';
        
        // Headers
        const headers = table.querySelectorAll('thead th');
        headers.forEach((th, index) => {
            textContent += th.textContent.trim();
            if (index < headers.length - 1) textContent += '\t';
        });
        textContent += '\n';
        
        // Body
        // We need to parse the HTML rows because we are using Razor to render them
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if(cells.length > 0) {
                 // Cell 1: Prize Name (nested in div)
                 const prizeName = cells[0].querySelector('.font-semibold') ? cells[0].querySelector('.font-semibold').textContent.trim() : '';
                 const amount = cells[0].querySelector('.opacity-75') ? cells[0].querySelector('.opacity-75').textContent.trim() : '';
                 const emoji = cells[0].querySelector('.text-2xl') ? cells[0].querySelector('.text-2xl').textContent.trim() : '';
                 
                 // Cell 2: No
                 const no = cells[1].textContent.trim();
                 
                 // Cell 3: ID
                 const id = cells[2].textContent.trim();
                 
                 textContent += `${prizeName} ${emoji} (${amount})\t${no}\t${id}\n`;
            }
        });
        
        navigator.clipboard.writeText(textContent).then(() => {
            showToast();
        }).catch(err => {
            console.error('Failed to copy:', err);
        });
    }

    function showToast() {
        const toast = document.getElementById('toast');
        toast.style.transform = 'translateY(0)';
        toast.style.opacity = '1';
        
        setTimeout(() => {
            toast.style.transform = 'translateY(20px)';
            toast.style.opacity = '0';
        }, 2000);
    }
    
    if(document.getElementById('copyBtn')) {
        document.getElementById('copyBtn').addEventListener('click', copyTableToClipboard);
    }

    // Animation Logic
    window.addEventListener('load', () => {
        const isWinner = document.getElementById('winnerPopup').style.display === 'flex';
        if (isWinner) {
            createConfetti();
            createMoneyRain();
            createSparkles();
        }
    });

    // Helper Animation Functions
    function createConfetti() {
        const colors = ['#fbbf24', '#10b981', '#6366f1', '#ec4899', '#f59e0b', '#8b5cf6'];
        for (let i = 0; i < 50; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-10px';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 3500);
            }, i * 50);
        }
    }

    function createMoneyRain() {
        const moneyEmojis = ['💵', '💰', '💸', '💴', '💶', '💷'];
        for (let i = 0; i < 30; i++) {
            setTimeout(() => {
                const money = document.createElement('div');
                money.className = 'money';
                money.textContent = moneyEmojis[Math.floor(Math.random() * moneyEmojis.length)];
                money.style.left = Math.random() * 100 + '%';
                money.style.top = '-50px';
                money.style.animationDelay = Math.random() * 0.8 + 's';
                money.style.animationDuration = (Math.random() * 2 + 3) + 's';
                document.body.appendChild(money);
                setTimeout(() => money.remove(), 5000);
            }, i * 100);
        }
    }

    function createSparkles() {
        const container = document.getElementById('winnerContainer');
        const sparkleColors = ['#fbbf24', '#ffffff', '#fef3c7'];
        if (!container) return;
        for (let i = 0; i < 12; i++) {
            const sparkle = document.createElement('div');
            sparkle.className = 'sparkle';
            sparkle.style.background = sparkleColors[Math.floor(Math.random() * sparkleColors.length)];
            sparkle.style.left = Math.random() * 100 + '%';
            sparkle.style.top = Math.random() * 100 + '%';
            sparkle.style.animationDelay = Math.random() * 1.5 + 's';
            container.appendChild(sparkle);
        }
    }
</script>