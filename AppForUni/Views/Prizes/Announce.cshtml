@model YourApp.Models.Employee
@{
    ViewData["Title"] = "ประกาศรางวัล";
    var prizeName = (string)(ViewBag.PrizeName ?? "");
    var prizeAmount = (string)(ViewBag.PrizeAmount ?? "");

    // The list from controller (Filtered by prizeName)
    var winnerIds = ViewBag.WinnerIds as List<string> ?? new List<string>();

    bool showSuccess = ViewBag.Success != null;
    bool showError = ViewBag.Error != null;
    string errorMsg = ViewBag.Error as string;
    string successMsg = ViewBag.Success as string;
}

<link rel="stylesheet" href="~/css/announce.css" />

<style>
    /* --- Layout --- */
    .announce-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        justify-content: center;
        align-items: flex-start;
        width: 100%;
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 20px;
        position: relative;
        z-index: 10;
    }

    .announce-card-section {
        flex: 1;
        min-width: 320px;
        max-width: 500px;
    }

    /* Right Side Table Panel */
    .winners-section {
        flex: 1;
        min-width: 300px;
        max-width: 400px;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 24px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        height: fit-content;
        max-height: 600px;
        display: flex;
        flex-direction: column;
    }

    .winners-header {
        font-family: 'Poppins', sans-serif;
        font-size: 18px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .winner-count-badge {
        background: #10b981;
        color: white;
        padding: 2px 10px;
        border-radius: 12px;
        font-size: 14px;
    }

    .winners-list-container {
        overflow-y: auto;
        flex-grow: 1;
        padding-right: 5px;
    }

    .table-custom {
        width: 100%;
        border-collapse: collapse;
    }

    .table-custom th {
        text-align: left;
        color: #64748b;
        font-size: 14px;
        padding: 8px;
        border-bottom: 1px solid #f1f5f9;
    }

    .table-custom td {
        padding: 10px 8px;
        border-bottom: 1px solid #f1f5f9;
        font-family: 'Courier New', monospace;
        font-weight: 600;
        color: #334155;
        font-size: 16px;
    }

    .table-custom tr:last-child td {
        border-bottom: none;
    }

    .animate-new {
        animation: highlightRow 2s ease-out;
    }

    @@keyframes highlightRow {
        0% {
            background-color: #d1fae5;
        }

        100% {
            background-color: transparent;
        }
    }

    /* Popup Styles */
    @@importurl('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&family=Poppins:wght@400;600;700;800&display=swap');

    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
        z-index: 9999;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.4s ease-out;
    }


    .popup-container.winner-theme {
        background: #ffffff;
        font-family: 'Poppins', sans-serif;
        color: #1e293b;
        max-width: 500px;
        border-radius: 24px;
        padding: 48px 40px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.1s forwards;

        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 550px;
    }

    .popup-container.nowin-theme {
        background: #ffffff;
        font-family: 'Quicksand', sans-serif;
        color: #0f172a;
        max-width: 480px;
        border-radius: 28px;
        padding: 56px 44px;
        text-align: center;
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15);
        animation: gentlePopIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s forwards;

        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 480px;
    }

    .trophy-icon {
        font-size: 80px;
        margin-bottom: 24px;
        animation: bounce 1s ease-in-out infinite;
        display: inline-block;
    }

    .winner-title {
        font-size: 48px;
        font-weight: 800;
        margin-bottom: 16px;
        color: #1e293b;
    }

    .winner-name {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 12px;
        color: #fbbf24;
    }

    .prize-box {
        display: inline-block;
        padding: 16px 32px;
        border-radius: 16px;
        margin: 24px 0;
        background: rgba(251, 191, 36, 0.15);
        border: 2px solid #fbbf24;
    }


    /* Updated .btn-claim to support <a> tag */
    .btn-claim {
        display: inline-block;
        /* Essential for <a> */
        padding: 18px 48px;
        border-radius: 50px;
        font-size: 18px;
        font-weight: 700;
        border: none;
        cursor: pointer;
        background: #10b981;
        color: white;
        text-decoration: none;
        /* No underline */
        text-align: center;
        transition: all 0.2s ease;
        margin-top: auto;
        width: 100%;
    }

    .btn-claim:hover {
        transform: translateY(-3px);
        color: white;
    }

    .emoji-icon {
        font-size: 72px;
        display: inline-block;
        animation: gentleFloat 2.5s ease-in-out infinite;
    }

    .main-title {
        font-size: 42px;
        font-weight: 700;
        margin-bottom: 12px;
    }

    .encouragement {
        font-size: 26px;
        font-weight: 600;
        margin-bottom: 28px;
        color: #3b82f6;
    }


    .btn-try-again {
        padding: 16px 42px;
        border-radius: 50px;
        font-size: 17px;
        font-weight: 700;
        border: none;
        cursor: pointer;
        background: #6366f1;
        color: white;
        margin-top: auto;
        width: 100%;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @@keyframes popIn {
        to {
            transform: scale(1);
        }
    }

    @@keyframes gentlePopIn {
        to {
            transform: scale(1);
        }
    }

    @@keyframes bounce {

        0%,
        100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-10px);
        }
    }

    @@keyframes gentleFloat {

        0%,
        100% {
            transform: translateY(0) rotate(-3deg);
        }

        50% {
            transform: translateY(-12px) rotate(3deg);
        }
    }

    @@keyframes confettiFall {
        to {
            transform: translateY(100vh) rotate(720deg);
            opacity: 0;
        }
    }

    @@keyframes moneyFall {
        0% {
            transform: translateY(-50px);
            opacity: 0.9;
        }

        100% {
            transform: translateY(100vh) rotate(360deg);
            opacity: 0;
        }
    }

    @@keyframes sparkle {

        0%,
        100% {
            opacity: 0;
            transform: scale(0);
        }

        50% {
            opacity: 1;
            transform: scale(1);
        }
    }

    .confetti {
        position: fixed;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        pointer-events: none;
        animation: confettiFall 3s ease-out forwards;
        z-index: 10000;
    }

    .money {
        position: fixed;
        font-size: 32px;
        pointer-events: none;
        animation: moneyFall 4s ease-out forwards;
        opacity: 0.9;
        z-index: 10000;
    }

    .sparkle {
        position: absolute;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        animation: sparkle 1.5s ease-in-out infinite;
    }
</style>

<div class="page-background-wrapper">
    <div class="radial-grid"></div>
    <div class="mesh-blob blob-1"></div>
    <div class="mesh-blob blob-2"></div>
</div>

<div class="announce-wrapper">

    <div class="announce-card-section">
        <div class="announce-card" style="width:100%;">
            <h2 class="page-title">ประกาศรางวัล</h2>
            <div class="prize-info-box">
                <div class="prize-name">@prizeName</div>
                <div class="prize-amount">@prizeAmount</div>
            </div>

            <form asp-action="Announce" method="post" class="form-section">
                @Html.AntiForgeryToken()
                <input type="hidden" name="prizeName" value="@prizeName" />
                <input type="hidden" name="prizeAmount" value="@prizeAmount" />

                <label class="input-label">สแกนบาร์โค้ด (EmployeeID)</label>
                <input id="scanBox" type="text" name="scannedCode" class="scan-input"
                    placeholder="สแกน/พิมพ์ EmployeeID" autofocus />

                <button type="submit" class="btn-submit">บันทึกผลรางวัล</button>
            </form>

            <div class="nav-footer">
                @*
                <a asp-action="Select" class="btn-nav-outline">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5" />
                <path d="M12 19l-7-7 7-7" />
                </svg>
                กลับ
                </a>
                <a asp-action="Search" class="btn-nav-outline">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
                </svg>
                ค้นหา
                </a>
                *@
            </div>
        </div>
    </div>

    <div class="winners-section">
        <div class="winners-header">
            <span>ผู้ได้รับ @prizeName</span>
            <span class="winner-count-badge">@winnerIds.Count คน</span>
        </div>

        <div class="winners-list-container">
            <table class="table-custom">
                <thead>
                    <tr>
                        <th style="width: 50px;">#</th>
                        <th>Employee ID</th>
                    </tr>
                </thead>
                <tbody>
                    @if (winnerIds.Count > 0)
                    {
                        int i = 1;
                        foreach (var id in winnerIds)
                        {
                            string rowClass = (i == 1 && showSuccess) ? "animate-new" : "";
                            <tr class="@rowClass">
                                <td style="color:#94a3b8;">@i</td>
                                <td>@id</td>
                            </tr>
                            i++;
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="2" style="text-align:center; color:#94a3b8; padding:20px;">
                                ยังไม่มีผู้ได้รับรางวัลนี้
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

</div>

<div id="winnerPopup" class="popup-overlay" style="@(showSuccess ? "display:flex;" : "display:none;")">
    <div class="popup-container winner-theme" id="winnerContainer">
        <div class="trophy-icon">🏆</div>
        <h1 class="winner-title">ขอแสดงความยินดี!</h1>
        <h2 class="winner-name">ID: @Model?.EmployeeID</h2>
        <h2 class="winner-name">@Model?.EmployeeName</h2>
        <div class="prize-box">
            <div style="font-size:14px; text-transform:uppercase;">คุณได้รับรางวัล</div>
            <div style="font-size:24px; font-weight:700;">@prizeName</div>
            <div>@prizeAmount</div>
        </div>

        <a href="@Url.Action("Announce", "Prizes", new { prizeName = prizeName, prizeAmount = prizeAmount })"
            class="btn-claim">
            ไปต่อ
        </a>

    </div>
</div>

<div id="errorPopup" class="popup-overlay" style="@(showError ? "display:flex;" : "display:none;")">
    <div class="popup-container nowin-theme">
        <div class="emoji-icon">😢</div>
        <h1 class="main-title">เสียใจด้วย</h1>
        <p class="encouragement">อุ๊ปส์!</p>
        <div style="padding:15px; background:rgba(59,130,246,0.1); border-radius:12px; margin:20px 0;">
            <p style="font-size:16px;">@errorMsg</p>
        </div>

        <button class="btn-try-again" onclick="closePopup('errorPopup')">ลองใหม่อีกครั้ง</button>
    </div>
</div>

<script>
    // Handle Enter key
    document.getElementById('scanBox').addEventListener('keydown', function (e) {
        if (e.key === 'Enter') { /* Default submit */ }
    });

    // Close Popup & Clear/Focus Input
    function closePopup(id) {
        document.getElementById(id).style.display = 'none';
        const scanBox = document.getElementById('scanBox');
        scanBox.value = ''; // Clear value so they can re-scan immediately
        scanBox.focus();
    }

    // Animation Logic
    window.addEventListener('load', () => {
        const isWinner = document.getElementById('winnerPopup').style.display === 'flex';
        if (isWinner) {
            createConfetti();
            createMoneyRain();
            createSparkles();
        }
    });

    // --- Animation Functions ---
    function createConfetti() {
        const colors = ['#fbbf24', '#10b981', '#6366f1', '#ec4899', '#f59e0b', '#8b5cf6'];
        for (let i = 0; i < 50; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-10px';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 3500);
            }, i * 50);
        }
    }

    function createMoneyRain() {
        const moneyEmojis = ['💵', '💰', '💸', '💴', '💶', '💷'];
        for (let i = 0; i < 30; i++) {
            setTimeout(() => {
                const money = document.createElement('div');
                money.className = 'money';
                money.textContent = moneyEmojis[Math.floor(Math.random() * moneyEmojis.length)];
                money.style.left = Math.random() * 100 + '%';
                money.style.top = '-50px';
                money.style.animationDelay = Math.random() * 0.8 + 's';
                money.style.animationDuration = (Math.random() * 2 + 3) + 's';
                document.body.appendChild(money);
                setTimeout(() => money.remove(), 5000);
            }, i * 100);
        }
    }

    function createSparkles() {
        const container = document.getElementById('winnerContainer');
        const sparkleColors = ['#fbbf24', '#ffffff', '#fef3c7'];
        if (!container) return;
        for (let i = 0; i < 12; i++) {
            const sparkle = document.createElement('div');
            sparkle.className = 'sparkle';
            sparkle.style.background = sparkleColors[Math.floor(Math.random() * sparkleColors.length)];
            sparkle.style.left = Math.random() * 100 + '%';
            sparkle.style.top = Math.random() * 100 + '%';
            sparkle.style.animationDelay = Math.random() * 1.5 + 's';
            container.appendChild(sparkle);
        }
    }
</script>